#!/bin/bash

# Function: apps_interface
apps_interface() {
    local app_name=$1
    local config_path="/pg/config/${app_name}.cfg"
    local default_appdata_path="/pg/appdata/${app_name}"
    local app_path="/pg/apps/${app_name}"

    # Function to check the Docker container status
    check_deployment_status() {
        local container_status=$(docker ps --filter "name=$app_name" --format "{{.Names}}")

        if [[ -n "$container_status" ]]; then
            echo -e "\033[0;32m[Deployed]\033[0m $app_name"  # Green
        else
            echo -e "\033[0;31m[Not Deployed]\033[0m $app_name"  # Red
        fi
    }

    # Create config file if it doesn't exist
    if [[ ! -f "$config_path" ]]; then
        touch "$config_path"
    fi

    # Store the app_name in the config file
    if ! grep -q '^app_name=' "$config_path"; then
        echo "app_name=${app_name}" >> "$config_path"
    fi

    # Set default appdata path if not set in config
    if ! grep -q '^appdata_path=' "$config_path"; then
        echo "appdata_path=${default_appdata_path}" >> "$config_path"
    fi

    # Read appdata_path from the config file
    source "$config_path"
    
    # Ensure the appdata directory exists and is executable
    if [[ ! -d "$appdata_path" ]]; then
        mkdir -p "$appdata_path"
        chmod +x "$appdata_path"
    fi

    # Menu
    while true; do
        clear
        check_deployment_status  # Display the initial status
        echo ""
        echo "1) Appdata Path: $appdata_path"
        echo "D) Deploy $app_name"
        echo "Z) Exit"
        echo ""

        read -p "Choose an option: " choice

        case $choice in
            1)
                echo "Appdata Path: $appdata_path"
                read -p "Press Enter to continue..."
                ;;
            D|d)
                if [[ -f "$app_path" ]]; then
                    echo "Deploying $app_name ..."
                    bash "$app_path" "$app_name"

                    # Notify the user that the app has been deployed and display the app name in blue
                    echo ""
                    echo -e "\033[0;34m${app_name}\033[0m has been deployed."
                    read -p "Press Enter to continue..."
                else
                    echo "Error: The app script for $app_name does not exist or is not executable."
                    read -p "Press Enter to continue..."
                fi

                # Refresh the deployment status after deployment
                clear
                check_deployment_status
                ;;
            Z|z)
                break
                ;;
            *)
                echo "Invalid option, please try again."
                read -p "Press Enter to continue..."
                ;;
        esac
    done
}
